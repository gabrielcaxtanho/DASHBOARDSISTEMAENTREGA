{% extends 'base.html' %}
{% block content %}

<div class="container-fluid py-4">
    <div class="row g-4">

        <!-- Card Financeiro -->
        <div class="col-12">
            <div class="card shadow-lg rounded-4 border-0">
                <div class="card-body">
                    <h4 class="card-title text-center mb-4 fw-bold">游눯 Status Financeiro do Projeto</h4>

                    <div class="progress rounded-pill" style="height: 35px;">
                        <div id="financeBar"
                             class="progress-bar bg-success fw-bold"
                             role="progressbar"
                             style="width: 0%; --target-width: {{ percentual_financeiro }}%;"
                             aria-valuenow="{{ percentual_financeiro }}"
                             aria-valuemin="0"
                             aria-valuemax="100">
                            {{ percentual_financeiro }}%
                        </div>
                    </div>

                    <p class="mt-3 text-center">
                        <strong>Entregue:</strong> R$ {{ "{:,.2f}".format(valor_entregue) }}
                        / <strong>Total:</strong> R$ {{ "{:,.2f}".format(valor_total_projeto) }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Card Status por Categoria -->
        <div class="col-12">
            <div class="card shadow-lg rounded-4 border-0">
                <div class="card-body">
                    <h4 class="card-title text-center mb-4 fw-bold">游닍 Status de Entregas por Categoria</h4>

<div class="d-flex flex-wrap gap-4 justify-content-center">
    {% for categoria, dados in status_data.items() %}
        {% set total = dados.entregues + dados.pendentes %}
        {% if total > 0 %}
            {% set porcentagem = (dados.entregues / total * 100) | round(0) %}
        {% else %}
            {% set porcentagem = 0 %}
        {% endif %}

        <div class="card border-0 shadow-sm p-3 rounded-4 text-center" style="width: 250px;">
            <!-- Gr치fico -->
            <canvas id="grafico_{{ loop.index }}" class="grafico-categoria"></canvas>

            <!-- Nome da Categoria -->
            <div class="mt-3 fw-bold">
                {% if categoria == 'maquina_tipo_1' %}M치quina Tipo 1{% endif %}
                {% if categoria == 'maquina_tipo_2' %}M치quina Tipo 2{% endif %}
                {% if categoria == 'maquina_tipo_3' %}M치quina Tipo 3{% endif %}
                {% if categoria == 'tela_tipo_1' %}Tela Tipo 1{% endif %}
                {% if categoria == 'tela_tipo_2' %}Tela Tipo 2{% endif %}
                {% if categoria == 'notebook_tipo_1' %}Notebook Tipo 1{% endif %}
                {% if categoria == 'notebook_tipo_2' %}Notebook Tipo 2{% endif %}
            </div>
        </div>
    {% endfor %}
</div>
                    <!-- Tabela -->
                    <div class="table-responsive mt-4">
                        <table class="table table-hover align-middle shadow-sm rounded-3 overflow-hidden">
                            <thead class="bg-dark text-white">
                                <tr>
                                    <th>Categoria</th>
                                    <th>Entregues</th>
                                    <th>Pendentes</th>
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for categoria, dados in status_data.items() %}
                                <tr>
                                    <td>
                                        {% if categoria == 'maquina_tipo_1' %}M치quina Tipo 1{% endif %}
                                        {% if categoria == 'maquina_tipo_2' %}M치quina Tipo 2{% endif %}
                                        {% if categoria == 'maquina_tipo_3' %}M치quina Tipo 3{% endif %}
                                        {% if categoria == 'tela_tipo_1' %}Tela Tipo 1{% endif %}
                                        {% if categoria == 'tela_tipo_2' %}Tela Tipo 2{% endif %}
                                        {% if categoria == 'notebook_tipo_1' %}Notebook Tipo 1{% endif %}
                                        {% if categoria == 'notebook_tipo_2' %}Notebook Tipo 2{% endif %}
                                    </td>
                                    <td><span class="badge bg-success">{{ dados.entregues }}</span></td>
                                    <td><span class="badge bg-warning text-dark">{{ dados.pendentes }}</span></td>
                                    <td>{{ dados.entregues + dados.pendentes }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>
        </div>

        <!-- Card Status por Setor -->
<div class="col-12">
    <div class="card shadow-lg rounded-4 border-0">
        <div class="card-body">
            <h4 class="card-title text-center mb-4 fw-bold">游낈 Status de Entregas por Setor</h4>

            <div id="setoresCarousel" class="carousel slide" data-bs-interval="false">
                <!-- Controles -->
                <button class="carousel-control-prev" type="button" data-bs-target="#setoresCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                    <span class="visually-hidden">Anterior</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#setoresCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                    <span class="visually-hidden">Pr칩ximo</span>
                </button>


    <div class="carousel-inner">

        {% set linhas_por_bloco = 6 %}
        {% for setor, dados in status_setor_data.items() %}
            {% if loop.index0 % linhas_por_bloco == 0 %}
                {% if not loop.first %}</tbody></table></div></div>{% endif %}
                <div class="carousel-item {% if loop.index0 == 0 %}active{% endif %}">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover mt-3">
                            <thead class="table-dark">
                                <tr>
                                    <th>Setor</th>
                                    <th>Entregues</th>
                                    <th>Pendentes</th>
                                    <th>Itens Entregues</th>
                                    <th>Itens Pendentes</th>
                                </tr>
                            </thead>
                            <tbody>
            {% endif %}

            <tr>
                <td>
                    <strong>{{ setor }}</strong>
                    {% set total = dados.entregues + dados.pendentes %}
                    {% if total > 0 %}
                        {% set porcentagem = (dados.entregues / total * 100) | round(2) %}
                        <div class="d-flex align-items-center mt-2" style="gap: 10px;">
                            <div class="progress w-100" style="height: 15px;">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="--target-width: {{ porcentagem }}%; width: {{ porcentagem }}%;"
                                     aria-valuenow="{{ porcentagem }}"
                                     aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <span><small>{{ porcentagem }}%</small></span>
                        </div>
                    {% else %}
                        <br><small class="text-muted">Nenhum item registrado</small>
                    {% endif %}
                </td>
                <td><span class="badge bg-success">{{ dados.entregues }}</span></td>
                <td><span class="badge bg-warning text-dark">{{ dados.pendentes }}</span></td>
                <td>
                    {% if dados.itens_entregues %}
                        {% set contagem_entregues = {} %}
                        {% for item in dados.itens_entregues %}
                            {% set tipo = item %}
                            {% if tipo in contagem_entregues %}
                                {% set _ = contagem_entregues.__setitem__(tipo, contagem_entregues[tipo] + 1) %}
                            {% else %}
                                {% set _ = contagem_entregues.__setitem__(tipo, 1) %}
                            {% endif %}
                        {% endfor %}
                        <ul>
                            {% for tipo, qtd in contagem_entregues.items() %}
                                <li>{{ qtd }} {{ tipo }}{{ 's' if qtd > 1 }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        Nenhum
                    {% endif %}
                </td>
                <td>
                    {% if dados.itens_pendentes %}
                        {% set contagem_pendentes = {} %}
                        {% for item in dados.itens_pendentes %}
                            {% set tipo = item %}
                            {% if tipo in contagem_pendentes %}
                                {% set _ = contagem_pendentes.__setitem__(tipo, contagem_pendentes[tipo] + 1) %}
                            {% else %}
                                {% set _ = contagem_pendentes.__setitem__(tipo, 1) %}
                            {% endif %}
                        {% endfor %}
                        <ul>
                            {% for tipo, qtd in contagem_pendentes.items() %}
                                <li>{{ qtd }} {{ tipo }}{{ 's' if qtd > 1 }}</li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        Nenhum
                    {% endif %}
                </td>
            </tr>

            {% if loop.last %}</tbody></table></div></div>{% endif %}
        {% endfor %}


                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
 <footer class="footer">
  <img src="{{ url_for('static', filename='tatto.png') }}" alt="Tatto Logo" class="footer-logo">
    <div class="footer-text">
      <p>춸 CHAVES</p>
      <p>춽 2025 </p>
    </div>
  </footer>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script>
    const graficosData = [
        {% for categoria, dados in status_data.items() %}
            {% set total = dados.entregues + dados.pendentes %}
            {% if total > 0 %}
                {{ (dados.entregues / total * 100) | round(0) }},
            {% else %}
                0,
            {% endif %}
        {% endfor %}
    ];

    graficosData.forEach((percentual, index) => {
    const ctx = document.getElementById(`grafico_${index+1}`).getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Entregues', 'Pendentes'],
            datasets: [{
                data: [percentual, 100 - percentual],
                backgroundColor: ['#28a745', '#e0e0e0'],
                borderWidth: 0
            }]
        },
        options: {
            cutout: '70%', // tamanho do "buraco" central
            plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
                datalabels: {
                    display: true,
                    color: '#000',
                    font: {
                        weight: 'bold',
                        size: 16
                    },
                    formatter: function(_, context) {
                        // S칩 mostra uma vez no meio
                        if (context.dataIndex === 0) {
                            return percentual + '%';
                        }
                        return '';
                    },
                    anchor: 'center',
                    align: 'center'
                }
            }
        },
        plugins: [ChartDataLabels]
    });
});
</script>
<script>
    window.addEventListener("load", () => {
        // Barra financeira
        const financeBar = document.getElementById("financeBar");
        financeBar.style.width = "{{ percentual_financeiro }}%";

        // Barras por categoria
        const categoryBars = document.querySelectorAll(".progress-bar.bg-success");
        categoryBars.forEach(bar => {
            const targetWidth = bar.style.getPropertyValue("--target-width");
            bar.style.width = targetWidth;
        });
    });
</script>
<script>
    const carousel = document.getElementById('setoresCarousel');
    const inner = carousel.querySelector('.carousel-inner');

    function adjustCarouselSize() {
        const activeItem = inner.querySelector('.carousel-item.active');
        if (activeItem) {
            inner.style.height = activeItem.offsetHeight + 'px';
        }
    }
    window.addEventListener('load', adjustCarouselSize);
    carousel.addEventListener('slid.bs.carousel', adjustCarouselSize);
</script>

<script>
    window.addEventListener("load", () => {
        const bar = document.getElementById("financeBar");
        bar.style.width = "{{ percentual_financeiro }}%";
    });
</script>
<style>
    body { background: #f8f9fc; }
    .card { background: #fff; }
    .progress-bar {
        animation: fillProgress 1.5s ease-out forwards;
        background-image: linear-gradient(45deg, rgba(255,255,255,0.2) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0.2) 75%, transparent 75%);
        background-size: 40px 40px;
    }
    @keyframes fillProgress { from { width: 0; } to { width: var(--target-width); } }
</style>
<style>
    * { font-family: monospace, bold !important; }
    .progress-bar.bg-success {
        animation: moveStripes 1s linear infinite, fillProgress 1.5s ease-out forwards;
        background-image: linear-gradient(
            45deg,
            rgba(255, 255, 255, 0.2) 25%,
            transparent 25%,
            transparent 50%,
            rgba(255, 255, 255, 0.2) 50%,
            rgba(255, 255, 255, 0.2) 75%,
            transparent 75%,
            transparent
        );
        background-size: 40px 40px;
    }
    @keyframes moveStripes { 0% { background-position: 0 0; } 100% { background-position: 40px 0; } }
    @keyframes fillProgress { from { width: 0; } to { width: var(--target-width); } }
    .carousel-item { transition: transform 0.6s ease, opacity 0.6s ease; }
    .carousel-control-prev, .carousel-control-next { filter: invert(100%); }
</style>

{% endblock %}